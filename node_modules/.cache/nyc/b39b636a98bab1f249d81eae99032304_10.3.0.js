"use strict";var cov_177maeahiw=function(){var path="C:\\Users\\chadc\\Documents\\git-projects\\infusion\\dist\\src\\infusion-server\\application-services\\proxy-service.js",hash="786c94f42d6309c5a9c4bdcfe3bafd357267b98e",global=new Function('return this')(),gcv="__coverage__",coverageData={path:"C:\\Users\\chadc\\Documents\\git-projects\\infusion\\dist\\src\\infusion-server\\application-services\\proxy-service.js",statementMap:{"0":{start:{line:2,column:0},end:{line:2,column:62}},"1":{start:{line:3,column:27},end:{line:3,column:64}},"2":{start:{line:4,column:15},end:{line:4,column:32}},"3":{start:{line:5,column:41},end:{line:5,column:116}},"4":{start:{line:6,column:42},end:{line:6,column:118}},"5":{start:{line:7,column:33},end:{line:7,column:100}},"6":{start:{line:8,column:40},end:{line:8,column:114}},"7":{start:{line:9,column:13},end:{line:9,column:28}},"8":{start:{line:10,column:14},end:{line:10,column:46}},"9":{start:{line:11,column:16},end:{line:11,column:34}},"10":{start:{line:60,column:0},end:{line:60,column:36}}},fnMap:{},branchMap:{},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0},f:{},b:{},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();++cov_177maeahiw.s[0];Object.defineProperty(exports,"__esModule",{value:true});const infusion_context_1=(++cov_177maeahiw.s[1],require("../domain/infusion-context"));const events=(++cov_177maeahiw.s[2],require("events"));const infusion_proxy_request_handler_1=(++cov_177maeahiw.s[3],require("../domain-services/event-handlers/infusion-proxy-request-handler"));const infusion_proxy_response_handler_1=(++cov_177maeahiw.s[4],require("../domain-services/event-handlers/infusion-proxy-response-handler"));const infusion_error_handler_1=(++cov_177maeahiw.s[5],require("../domain-services/event-handlers/infusion-error-handler"));const infusion_path_rewrite_handler_1=(++cov_177maeahiw.s[6],require("../domain-services/event-handlers/infusion-path-rewrite-handler"));const http=(++cov_177maeahiw.s[7],require("http"));const proxy=(++cov_177maeahiw.s[8],require("http-proxy-middleware"));const express=(++cov_177maeahiw.s[9],require("express"));class ProxyService extends events.EventEmitter{/* istanbul ignore next */constructor(log,markupModifier,writer,configuration){super();this.log=log;this.writer=writer;this.configuration=configuration;this.markupModifier=markupModifier;this.expressApp=express();}/* istanbul ignore next */listen(infusionPort,target,port){this.proxy=this.createProxyServer(target);this.expressApp.use(this.proxy);this.log.info(`ProxyService.listen(target: ${target}, port: ${port})`);http.createServer(this.expressApp).listen(port);}/* istanbul ignore next */createProxyServer(target){return proxy('/',{target:target,changeOrigin:true,agent:new http.Agent({keepAlive:true}),logLevel:this.log.level,pathRewrite:(path,req)=>{this.log.debug(`ProxyService.setupProxyService.pathRewrite, path=${path}`);req.newPath='';new infusion_path_rewrite_handler_1.InfusionPathRewriteHandler(this.log).handle(path,req);if(req.newPath){this.log.debug(`ProxyService.setupProxyService.pathRewrite - newPath=${req.newPath}`);return req.newPath;}},onError:(err,req,res)=>{new infusion_error_handler_1.InfusionErrorHandler(this.log).handle(err,req,res);},onProxyRes:(proxyRes,req,res)=>{let context=req.context;this.markupModifier.performModifications(context.request.fullUrl,req,res);new infusion_proxy_response_handler_1.InfusionProxyResponseHandler(this.log).handle(proxyRes,req,res);req.context.direction=infusion_context_1.InfusionContextDirection.Response;this.writer.write(req.context);},onProxyReq:(proxyReq,req,res)=>{new infusion_proxy_request_handler_1.InfusionProxyRequestHandler(this.log,this.configuration).handle(proxyReq,req,res);req.context.direction=infusion_context_1.InfusionContextDirection.Request;}});}}++cov_177maeahiw.s[10];exports.ProxyService=ProxyService;