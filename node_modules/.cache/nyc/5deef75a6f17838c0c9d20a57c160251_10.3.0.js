"use strict";var cov_170ozbxvbt=function(){var path="C:\\Users\\chadc\\Documents\\git-projects\\infusion\\dist\\src\\infusion-server\\infrastructure\\infusion-context-mssql-writer.js",hash="dfda4cf7e9215853a6e8321009535b33191d45b8",global=new Function('return this')(),gcv="__coverage__",coverageData={path:"C:\\Users\\chadc\\Documents\\git-projects\\infusion\\dist\\src\\infusion-server\\infrastructure\\infusion-context-mssql-writer.js",statementMap:{"0":{start:{line:2,column:16},end:{line:9,column:1}},"1":{start:{line:3,column:4},end:{line:8,column:7}},"2":{start:{line:4,column:36},end:{line:4,column:97}},"3":{start:{line:4,column:42},end:{line:4,column:70}},"4":{start:{line:4,column:85},end:{line:4,column:95}},"5":{start:{line:5,column:35},end:{line:5,column:100}},"6":{start:{line:5,column:41},end:{line:5,column:73}},"7":{start:{line:5,column:88},end:{line:5,column:98}},"8":{start:{line:6,column:32},end:{line:6,column:149}},"9":{start:{line:6,column:97},end:{line:6,column:119}},"10":{start:{line:7,column:8},end:{line:7,column:78}},"11":{start:{line:10,column:0},end:{line:10,column:62}},"12":{start:{line:11,column:34},end:{line:11,column:87}},"13":{start:{line:12,column:12},end:{line:12,column:28}},"14":{start:{line:15,column:8},end:{line:15,column:48}},"15":{start:{line:16,column:8},end:{line:20,column:10}},"16":{start:{line:23,column:0},end:{line:23,column:76}},"17":{start:{line:26,column:8},end:{line:26,column:23}},"18":{start:{line:27,column:8},end:{line:27,column:29}},"19":{start:{line:30,column:8},end:{line:101,column:11}},"20":{start:{line:31,column:12},end:{line:33,column:13}},"21":{start:{line:32,column:16},end:{line:32,column:23}},"22":{start:{line:34,column:12},end:{line:37,column:13}},"23":{start:{line:35,column:16},end:{line:35,column:43}},"24":{start:{line:36,column:16},end:{line:36,column:23}},"25":{start:{line:38,column:25},end:{line:38,column:60}},"26":{start:{line:39,column:12},end:{line:41,column:15}},"27":{start:{line:40,column:16},end:{line:40,column:53}},"28":{start:{line:42,column:12},end:{line:42,column:44}},"29":{start:{line:43,column:12},end:{line:100,column:13}},"30":{start:{line:44,column:29},end:{line:92,column:11}},"31":{start:{line:95,column:16},end:{line:95,column:36}},"32":{start:{line:96,column:16},end:{line:96,column:36}},"33":{start:{line:99,column:16},end:{line:99,column:29}},"34":{start:{line:104,column:8},end:{line:138,column:11}},"35":{start:{line:105,column:12},end:{line:137,column:13}},"36":{start:{line:106,column:27},end:{line:106,column:57}},"37":{start:{line:107,column:16},end:{line:109,column:17}},"38":{start:{line:108,column:20},end:{line:108,column:55}},"39":{start:{line:110,column:29},end:{line:133,column:12}},"40":{start:{line:136,column:16},end:{line:136,column:54}},"41":{start:{line:141,column:8},end:{line:143,column:12}},"42":{start:{line:142,column:12},end:{line:142,column:73}},"43":{start:{line:146,column:8},end:{line:148,column:9}},"44":{start:{line:147,column:12},end:{line:147,column:25}},"45":{start:{line:149,column:8},end:{line:156,column:11}},"46":{start:{line:150,column:30},end:{line:150,column:70}},"47":{start:{line:151,column:12},end:{line:155,column:13}},"48":{start:{line:152,column:16},end:{line:154,column:17}},"49":{start:{line:153,column:20},end:{line:153,column:32}},"50":{start:{line:157,column:8},end:{line:157,column:21}},"51":{start:{line:160,column:0},end:{line:160,column:64}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:2,column:44},end:{line:2,column:45}},loc:{start:{line:2,column:89},end:{line:9,column:1}},line:2},"1":{name:"(anonymous_1)",decl:{start:{line:3,column:36},end:{line:3,column:37}},loc:{start:{line:3,column:63},end:{line:8,column:5}},line:3},"2":{name:"fulfilled",decl:{start:{line:4,column:17},end:{line:4,column:26}},loc:{start:{line:4,column:34},end:{line:4,column:99}},line:4},"3":{name:"rejected",decl:{start:{line:5,column:17},end:{line:5,column:25}},loc:{start:{line:5,column:33},end:{line:5,column:102}},line:5},"4":{name:"step",decl:{start:{line:6,column:17},end:{line:6,column:21}},loc:{start:{line:6,column:30},end:{line:6,column:151}},line:6},"5":{name:"(anonymous_5)",decl:{start:{line:6,column:76},end:{line:6,column:77}},loc:{start:{line:6,column:95},end:{line:6,column:121}},line:6},"6":{name:"(anonymous_6)",decl:{start:{line:14,column:4},end:{line:14,column:5}},loc:{start:{line:14,column:50},end:{line:21,column:5}},line:14},"7":{name:"(anonymous_7)",decl:{start:{line:25,column:4},end:{line:25,column:5}},loc:{start:{line:25,column:29},end:{line:28,column:5}},line:25},"8":{name:"(anonymous_8)",decl:{start:{line:29,column:4},end:{line:29,column:5}},loc:{start:{line:29,column:19},end:{line:102,column:5}},line:29},"9":{name:"(anonymous_9)",decl:{start:{line:30,column:47},end:{line:30,column:48}},loc:{start:{line:30,column:60},end:{line:101,column:9}},line:30},"10":{name:"(anonymous_10)",decl:{start:{line:39,column:29},end:{line:39,column:30}},loc:{start:{line:39,column:36},end:{line:41,column:13}},line:39},"11":{name:"(anonymous_11)",decl:{start:{line:103,column:4},end:{line:103,column:5}},loc:{start:{line:103,column:17},end:{line:139,column:5}},line:103},"12":{name:"(anonymous_12)",decl:{start:{line:104,column:47},end:{line:104,column:48}},loc:{start:{line:104,column:60},end:{line:138,column:9}},line:104},"13":{name:"(anonymous_13)",decl:{start:{line:140,column:4},end:{line:140,column:5}},loc:{start:{line:140,column:29},end:{line:144,column:5}},line:140},"14":{name:"(anonymous_14)",decl:{start:{line:141,column:60},end:{line:141,column:61}},loc:{start:{line:141,column:67},end:{line:143,column:9}},line:141},"15":{name:"(anonymous_15)",decl:{start:{line:145,column:4},end:{line:145,column:5}},loc:{start:{line:145,column:39},end:{line:158,column:5}},line:145},"16":{name:"(anonymous_16)",decl:{start:{line:149,column:62},end:{line:149,column:63}},loc:{start:{line:149,column:75},end:{line:156,column:9}},line:149}},branchMap:{"0":{loc:{start:{line:2,column:16},end:{line:9,column:1}},type:"binary-expr",locations:[{start:{line:2,column:17},end:{line:2,column:21}},{start:{line:2,column:25},end:{line:2,column:39}},{start:{line:2,column:44},end:{line:9,column:1}}],line:2},"1":{loc:{start:{line:3,column:16},end:{line:3,column:34}},type:"binary-expr",locations:[{start:{line:3,column:16},end:{line:3,column:17}},{start:{line:3,column:22},end:{line:3,column:33}}],line:3},"2":{loc:{start:{line:6,column:32},end:{line:6,column:148}},type:"cond-expr",locations:[{start:{line:6,column:46},end:{line:6,column:67}},{start:{line:6,column:70},end:{line:6,column:148}}],line:6},"3":{loc:{start:{line:7,column:51},end:{line:7,column:67}},type:"binary-expr",locations:[{start:{line:7,column:51},end:{line:7,column:61}},{start:{line:7,column:65},end:{line:7,column:67}}],line:7},"4":{loc:{start:{line:31,column:12},end:{line:33,column:13}},type:"if",locations:[{start:{line:31,column:12},end:{line:33,column:13}},{start:{line:31,column:12},end:{line:33,column:13}}],line:31},"5":{loc:{start:{line:34,column:12},end:{line:37,column:13}},type:"if",locations:[{start:{line:34,column:12},end:{line:37,column:13}},{start:{line:34,column:12},end:{line:37,column:13}}],line:34},"6":{loc:{start:{line:107,column:16},end:{line:109,column:17}},type:"if",locations:[{start:{line:107,column:16},end:{line:109,column:17}},{start:{line:107,column:16},end:{line:109,column:17}}],line:107},"7":{loc:{start:{line:146,column:8},end:{line:148,column:9}},type:"if",locations:[{start:{line:146,column:8},end:{line:148,column:9}},{start:{line:146,column:8},end:{line:148,column:9}}],line:146},"8":{loc:{start:{line:151,column:12},end:{line:155,column:13}},type:"if",locations:[{start:{line:151,column:12},end:{line:155,column:13}},{start:{line:151,column:12},end:{line:155,column:13}}],line:151},"9":{loc:{start:{line:152,column:16},end:{line:154,column:17}},type:"if",locations:[{start:{line:152,column:16},end:{line:154,column:17}},{start:{line:152,column:16},end:{line:154,column:17}}],line:152}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(++cov_170ozbxvbt.s[0],(++cov_170ozbxvbt.b[0][0],this)&&(++cov_170ozbxvbt.b[0][1],this.__awaiter)||(++cov_170ozbxvbt.b[0][2],function(thisArg,_arguments,P,generator){++cov_170ozbxvbt.f[0];++cov_170ozbxvbt.s[1];return new((++cov_170ozbxvbt.b[1][0],P)||(++cov_170ozbxvbt.b[1][1],P=Promise))(function(resolve,reject){++cov_170ozbxvbt.f[1];function fulfilled(value){++cov_170ozbxvbt.f[2];++cov_170ozbxvbt.s[2];try{++cov_170ozbxvbt.s[3];step(generator.next(value));}catch(e){++cov_170ozbxvbt.s[4];reject(e);}}function rejected(value){++cov_170ozbxvbt.f[3];++cov_170ozbxvbt.s[5];try{++cov_170ozbxvbt.s[6];step(generator["throw"](value));}catch(e){++cov_170ozbxvbt.s[7];reject(e);}}function step(result){++cov_170ozbxvbt.f[4];++cov_170ozbxvbt.s[8];result.done?(++cov_170ozbxvbt.b[2][0],resolve(result.value)):(++cov_170ozbxvbt.b[2][1],new P(function(resolve){++cov_170ozbxvbt.f[5];++cov_170ozbxvbt.s[9];resolve(result.value);}).then(fulfilled,rejected));}++cov_170ozbxvbt.s[10];step((generator=generator.apply(thisArg,(++cov_170ozbxvbt.b[3][0],_arguments)||(++cov_170ozbxvbt.b[3][1],[]))).next());});}));++cov_170ozbxvbt.s[11];Object.defineProperty(exports,"__esModule",{value:true});const infusion_context_writer_1=(++cov_170ozbxvbt.s[12],require("../domain-services/infusion-context-writer"));const sql=(++cov_170ozbxvbt.s[13],require('mssql'));class InfusionContextMssqlWriterConfig extends infusion_context_writer_1.InfusionContextWriterConfiguration{constructor(user,password,server,database){++cov_170ozbxvbt.f[6];++cov_170ozbxvbt.s[14];super(user,password,server,database);++cov_170ozbxvbt.s[15];this.pool={max:10,min:0,idleTimeoutMillis:30000};}}++cov_170ozbxvbt.s[16];exports.InfusionContextMssqlWriterConfig=InfusionContextMssqlWriterConfig;class InfusionContextMssqlWriter{constructor(log,config){++cov_170ozbxvbt.f[7];++cov_170ozbxvbt.s[17];this.log=log;++cov_170ozbxvbt.s[18];this.config=config;}write(context){++cov_170ozbxvbt.f[8];++cov_170ozbxvbt.s[19];return __awaiter(this,void 0,void 0,function*(){++cov_170ozbxvbt.f[9];++cov_170ozbxvbt.s[20];if(this.isIrrelevantUrl(context)){++cov_170ozbxvbt.b[4][0];++cov_170ozbxvbt.s[21];return;}else{++cov_170ozbxvbt.b[4][1];}++cov_170ozbxvbt.s[22];if(this.isIrrelevantResponseTypes(context)){++cov_170ozbxvbt.b[5][0];++cov_170ozbxvbt.s[23];this.log.error('FOUND!!!');++cov_170ozbxvbt.s[24];return;}else{++cov_170ozbxvbt.b[5][1];}const pool=(++cov_170ozbxvbt.s[25],new sql.ConnectionPool(this.config));++cov_170ozbxvbt.s[26];pool.on('error',err=>{++cov_170ozbxvbt.f[10];++cov_170ozbxvbt.s[27];this.log.error(`sql errors: ${err}`);});++cov_170ozbxvbt.s[28];yield pool.connect(this.config);++cov_170ozbxvbt.s[29];try{let result=(++cov_170ozbxvbt.s[30],yield pool.request().input('responseBody',sql.VarChar(sql.MAX),context.response.body).input('responseHeaders',sql.VarChar(8000),JSON.stringify(context.response.headers)).input('responseStatusCode',sql.Char(255),context.response.statusCode).input('requestBody',sql.VarChar(sql.MAX),context.request.body).input('requestHeaders',sql.VarChar(8000),JSON.stringify(context.request.headers)).input('requestUrl',sql.VarChar(3000),context.request.fullUrl).input('requestProtocol',sql.Char(10),context.request.protocol).input('requestHost',sql.VarChar(3000),context.request.host).input('requestMethod',sql.Char(10),context.request.method).input('requestApplicationSessionId',sql.Char(255),context.request.sessionId).input('modifications',sql.VarChar(4000),JSON.stringify(context.config.modifications)).input('rewritePath',sql.Char(255),context.rewritePath).input('error',sql.VarChar(2000),context.error).input('userName',sql.Char(255),context.user).query(`
          INSERT INTO [usproxy].[dbo].[context]
          ([time]
          ,[responseBody]
          ,[responseHeaders]
          ,[responseStatusCode]
          ,[requestBody]
          ,[requestHeaders]
          ,[requestUrl]
          ,[requestProtocol]
          ,[requestHost]
          ,[requestMethod]
          ,[requestApplicationSessionId]
          ,[modifications]
          ,[rewritePath]
          ,[error]
          ,[userName])
      VALUES (
          GETDATE()
          ,@responseBody
          ,@responseHeaders
          ,@responseStatusCode
          ,@requestBody
          ,@requestHeaders
          ,@requestUrl
          ,@requestProtocol
          ,@requestHost
          ,@requestMethod
          ,@requestApplicationSessionId
          ,@modifications
          ,@rewritePath
          ,@error
          ,@userName
        )`));}catch(err){++cov_170ozbxvbt.s[31];this.log.error(err);++cov_170ozbxvbt.s[32];return{err:err};}finally{++cov_170ozbxvbt.s[33];pool.close();}});}initialize(){++cov_170ozbxvbt.f[11];++cov_170ozbxvbt.s[34];return __awaiter(this,void 0,void 0,function*(){++cov_170ozbxvbt.f[12];++cov_170ozbxvbt.s[35];try{let pool=(++cov_170ozbxvbt.s[36],yield sql.connect(this.config));++cov_170ozbxvbt.s[37];if(pool){++cov_170ozbxvbt.b[6][0];++cov_170ozbxvbt.s[38];this.log.debug('created sql pool');}else{++cov_170ozbxvbt.b[6][1];}let result=(++cov_170ozbxvbt.s[39],yield pool.request().query(`
          IF  NOT EXISTS (SELECT * FROM sys.objects 
            WHERE object_id = OBJECT_ID(N'[dbo].[context]') 
            AND type in (N'U'))
            CREATE TABLE [dbo].[context](
              [contextId] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
              [time] [datetime] DEFAULT GETDATE() NOT NULL,
              [responseBody] [VarChar](max) NULL,
              [responseHeaders] [VarChar](8000) NULL,
              [responseStatusCode] [Char](255) NULL,
              [requestBody] [VarChar](max) NULL,
              [requestHeaders] [VarChar](8000) NULL,
              [requestUrl] [VarChar](3000) NULL,
              [requestProtocol] [Char](10) NULL,
              [requestHost] [VarChar](3000) NULL,
              [requestMethod] [Char](10) NULL,
              [requestApplicationSessionId] [Char](255) NULL,
              [modifications] [VarChar](4000) NULL,
              [rewritePath] [Char](255) NULL,
              [error] [VarChar](2000) NULL,
              [userName] [Char](255) NULL
            )

          `));}catch(err){++cov_170ozbxvbt.s[40];this.log.error(`err: ${err.message}`);}});}isIrrelevantUrl(context){++cov_170ozbxvbt.f[13];++cov_170ozbxvbt.s[41];return context.config.irrelevantUrlSubstrings.some(s=>{++cov_170ozbxvbt.f[14];++cov_170ozbxvbt.s[42];return context.request.fullUrl.toLowerCase().indexOf(s)>=0;});}isIrrelevantResponseTypes(context){++cov_170ozbxvbt.f[15];++cov_170ozbxvbt.s[43];if(!context.response.headers){++cov_170ozbxvbt.b[7][0];++cov_170ozbxvbt.s[44];return false;}else{++cov_170ozbxvbt.b[7][1];}++cov_170ozbxvbt.s[45];context.config.irrelevantResponseContentTypes.forEach(pattern=>{++cov_170ozbxvbt.f[16];let contentType=(++cov_170ozbxvbt.s[46],context.response.headers['content-type']);++cov_170ozbxvbt.s[47];if(contentType){++cov_170ozbxvbt.b[8][0];++cov_170ozbxvbt.s[48];if(pattern.test(contentType)){++cov_170ozbxvbt.b[9][0];++cov_170ozbxvbt.s[49];return true;}else{++cov_170ozbxvbt.b[9][1];}}else{++cov_170ozbxvbt.b[8][1];}});++cov_170ozbxvbt.s[50];return false;}}++cov_170ozbxvbt.s[51];exports.InfusionContextMssqlWriter=InfusionContextMssqlWriter;